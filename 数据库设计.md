# 数据库设计文档

## 数据库类型
SQLite (better-sqlite3)

## 表结构

### 1. users (用户表)
存储用户基本信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | TEXT | PRIMARY KEY | 用户ID |
| email | TEXT | | 用户邮箱（可选） |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

### 2. checkins (打卡记录表)
存储用户每日打卡记录

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | TEXT | PRIMARY KEY | 打卡记录ID |
| user_id | TEXT | NOT NULL, FOREIGN KEY | 用户ID（关联users表） |
| checkin_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 打卡时间 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- idx_checkins_user_id: 用户ID索引
- idx_checkins_checkin_time: 打卡时间索引

### 3. user_settings (用户设置表)
存储用户的个人设置和偏好

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | TEXT | PRIMARY KEY | 设置ID |
| user_id | TEXT | NOT NULL, UNIQUE, FOREIGN KEY | 用户ID（关联users表） |
| email_notify | INTEGER | DEFAULT 1 | 邮件通知开关（0/1） |
| sms_notify | INTEGER | DEFAULT 1 | 短信通知开关（0/1） |
| auto_alarm | INTEGER | DEFAULT 0 | 自动报警开关（0/1） |
| alarm_threshold_hours | INTEGER | DEFAULT 12 | 报警阈值（小时） |
| email | TEXT | | 通知邮箱 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

### 4. emergency_contacts (紧急联系人表)
存储用户的紧急联系人信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | TEXT | PRIMARY KEY | 联系人ID |
| user_id | TEXT | NOT NULL, FOREIGN KEY | 用户ID（关联users表） |
| name | TEXT | NOT NULL | 联系人姓名 |
| phone | TEXT | NOT NULL | 联系电话 |
| type | TEXT | NOT NULL, CHECK | 类型：'mobile' 或 'home' |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

## 关系说明

1. **users ↔ checkins**: 一对多关系
   - 一个用户可以有多个打卡记录
   - 删除用户时，相关打卡记录会被级联删除

2. **users ↔ user_settings**: 一对一关系
   - 每个用户只有一份设置
   - 删除用户时，相关设置会被级联删除

3. **users ↔ emergency_contacts**: 一对多关系
   - 一个用户可以有多个紧急联系人（最多5个）
   - 删除用户时，相关联系人会被级联删除

## 默认数据

系统会自动创建一个默认用户：
- 用户ID: `default-user`
- 默认设置：邮件通知开启，短信通知开启，自动报警关闭

## 数据约束

1. **外键约束**: 已启用，确保数据完整性
2. **联系人类型约束**: 只能是 'mobile' 或 'home'
3. **联系人数量限制**: 应用层限制最多5个联系人

## 性能优化

1. 在 `checkins` 表的 `user_id` 和 `checkin_time` 字段上创建了索引
2. 使用 SQLite 的预编译语句提高查询性能
3. 外键约束确保数据一致性
