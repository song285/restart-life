# 调试多用户数据隔离问题

## 问题现象
不同设备访问网站时，X-Device-Id 不同，但前端渲染的数据还是一样的。

## 可能的原因

### 1. 浏览器缓存问题
浏览器可能缓存了 API 响应，导致不同设备看到相同的数据。

**解决方案：**
- 清除浏览器缓存
- 使用无痕模式测试
- 添加缓存控制头（已添加 `cache: 'no-store'`）

### 2. 请求头大小写问题
Express 会将请求头转换为小写，但前端可能发送了不同的大小写。

**已修复：** 使用小写 `x-device-id`

### 3. 后端没有正确识别用户
检查后端日志，确认用户识别是否正常工作。

## 调试步骤

### 步骤1：检查前端设备ID
在浏览器控制台执行：
```javascript
localStorage.getItem('restart-life-device-id')
```

不同设备应该有不同的设备ID。

### 步骤2：检查网络请求
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 刷新页面
4. 查看 API 请求（如 `/api/checkin/stats`）
5. 检查请求头中是否包含 `X-Device-Id`
6. 检查响应数据是否不同

### 步骤3：检查后端日志
查看后端日志，确认用户识别：
```bash
pm2 logs restart-life-backend
```

应该看到类似这样的日志：
```
🔍 用户识别中间件: { 'x-device-id': 'device-xxx', ... }
✅ 用户识别成功: deviceId=device-xxx, userId=device-xxx
```

### 步骤4：直接查询数据库
```bash
cd backend
sqlite3 data/database.db

# 查看所有用户
SELECT * FROM users;

# 查看打卡记录（按用户分组）
SELECT user_id, COUNT(*) as count FROM checkins GROUP BY user_id;

# 查看特定用户的打卡记录
SELECT * FROM checkins WHERE user_id = 'device-xxx';
```

## 快速测试方法

### 方法1：使用不同浏览器
1. 在 Chrome 中访问网站
2. 在 Firefox（或 Safari）中访问网站
3. 两个浏览器应该有独立的设备ID和数据

### 方法2：清除设备ID测试
在浏览器控制台执行：
```javascript
// 清除设备ID
localStorage.removeItem('restart-life-device-id');

// 刷新页面，会生成新的设备ID
location.reload();
```

### 方法3：使用无痕模式
打开无痕/隐私模式窗口，应该会创建新的设备ID。

## 已添加的调试功能

1. **前端调试日志**
   - 在开发模式下，会在控制台输出 API 请求和设备ID
   - 查看浏览器控制台即可

2. **后端调试日志**
   - 在开发模式下，会输出用户识别过程
   - 查看 PM2 日志即可

3. **禁用缓存**
   - API 请求已添加 `cache: 'no-store'`
   - 确保每次请求都是最新的

## 如果问题仍然存在

1. **检查后端是否已更新**
   ```bash
   cd backend
   npm run build
   pm2 restart restart-life-backend
   ```

2. **检查前端是否已更新**
   ```bash
   npm run build
   # 清除浏览器缓存
   ```

3. **检查 Nginx 配置**
   确保 Nginx 正确传递请求头：
   ```nginx
   proxy_set_header X-Device-Id $http_x_device_id;
   ```

4. **查看完整日志**
   ```bash
   # 后端日志
   pm2 logs restart-life-backend --lines 100
   
   # 浏览器控制台
   # 打开 F12，查看 Console 和 Network 标签
   ```

## 预期行为

- ✅ 不同设备有不同的设备ID
- ✅ 不同设备看到不同的打卡数据
- ✅ 不同设备有独立的设置和联系人
- ✅ 在一个设备打卡，不影响其他设备
