# 提醒功能说明

## 功能概述

系统实现了自动提醒和报警功能，确保用户的安全状态得到及时关注。

## 提醒规则

### 1. 邮件提醒（今天未打卡）

**触发条件：**
- 用户今天没有进行打卡
- 用户开启了邮件通知（`email_notify = true`）
- 用户已配置邮箱地址

**发送频率：**
- 每天只发送一次邮件提醒
- 定时检查：每小时检查一次，每天上午9点和晚上8点额外检查

**邮件内容：**
- 提醒用户今天还没有打卡
- 包含打卡链接

### 2. 紧急报警短信（超过3天未打卡）

**触发条件：**
- 用户连续3天或以上没有打卡
- 用户开启了自动报警（`auto_alarm = true`）
- 用户已添加紧急联系人

**发送对象：**
- 所有紧急联系人（最多5个）
- 发送短信到联系人的手机号码

**发送频率：**
- 每个未打卡天数只发送一次（避免重复发送）
- 例如：第3天发送一次，第4天发送一次，以此类推

**短信内容：**
- 包含用户名
- 包含未打卡天数
- 提醒联系人尽快联系用户确认安全

## 定时任务

系统使用 `node-cron` 实现定时检查：

1. **每小时检查**：`0 * * * *` - 每小时整点检查一次
2. **提醒时间检查**：`0 9,20 * * *` - 每天上午9点和晚上8点检查
3. **启动时检查**：服务器启动5秒后执行一次初始检查

## 配置说明

### 邮件服务配置

在 `backend/.env` 文件中配置SMTP：

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_FROM=noreply@restartlife.com
```

**常用邮箱SMTP配置：**

- **Gmail**: 
  - Host: smtp.gmail.com
  - Port: 587
  - 需要启用"应用专用密码"

- **QQ邮箱**:
  - Host: smtp.qq.com
  - Port: 587
  - 需要开启SMTP服务并获取授权码

- **163邮箱**:
  - Host: smtp.163.com
  - Port: 25 或 465

### 短信服务配置

在 `backend/.env` 文件中配置Twilio：

```env
TWILIO_ACCOUNT_SID=your_account_sid
TWILIO_AUTH_TOKEN=your_auth_token
TWILIO_PHONE_NUMBER=+1234567890
```

**Twilio注册：**
1. 访问 https://www.twilio.com 注册账号
2. 获取 Account SID 和 Auth Token
K4KDBSX2WFSGQTKXUG73XUYL
3. 购买电话号码（支持短信功能）

### 开发模式

如果不配置SMTP和Twilio，系统会在开发模式下模拟发送：
- 邮件：打印日志，不实际发送
- 短信：打印日志，不实际发送

## 手动触发检查

可以通过API手动触发检查（用于测试）：

```bash
POST /api/monitor/check
Content-Type: application/json

{
  "userId": "default-user"
}
```

## 防重复发送机制

系统实现了防重复发送机制：
- 邮件提醒：每天每个用户只发送一次
- 短信报警：每个未打卡天数只发送一次
- 自动清理：保留最近7天的发送记录

## 注意事项

1. **时区问题**：系统使用服务器本地时区，确保服务器时区设置正确
2. **网络问题**：如果邮件/短信服务不可用，系统会记录错误但不会中断服务
3. **联系人限制**：紧急联系人最多5个
4. **电话号码格式**：系统会自动格式化电话号码（移除空格和特殊字符）

## 测试建议

1. **测试邮件提醒**：
   - 关闭邮件通知，确保不发送
   - 开启邮件通知，配置邮箱，确保发送成功

2. **测试紧急报警**：
   - 关闭自动报警，确保不发送
   - 开启自动报警，添加联系人，模拟3天未打卡，确保发送成功

3. **测试防重复**：
   - 多次触发检查，确保不会重复发送
