# 多用户支持功能说明

## 功能概述

系统现在支持多个用户同时使用，每个设备/IP 会自动创建独立的用户账户，数据完全隔离。

## 工作原理

### 1. 用户识别机制

系统使用三层识别机制（按优先级）：

1. **设备ID**（推荐）
   - 前端自动生成唯一设备ID
   - 存储在浏览器的 `localStorage` 中
   - 通过请求头 `X-Device-Id` 发送到后端
   - 格式：`device-{timestamp}-{random}`

2. **查询参数/请求体**
   - 如果请求中包含 `deviceId` 参数，使用该参数

3. **IP地址**（备用）
   - 如果前两种方式都没有，使用客户端IP地址
   - 格式：`ip-{ip地址}`（例如：`ip-192-168-1-1`）

### 2. 自动用户创建

- 当新设备首次访问时，系统自动创建新用户
- 用户ID就是设备ID或IP地址
- 同时自动创建默认设置

### 3. 数据隔离

每个用户的数据完全独立：
- ✅ 打卡记录
- ✅ 用户设置
- ✅ 紧急联系人
- ✅ 统计数据

## 前端实现

### 设备ID生成

```typescript
// 自动生成并存储设备ID
function getDeviceId(): string {
  const STORAGE_KEY = 'restart-life-device-id';
  let deviceId = localStorage.getItem(STORAGE_KEY);
  
  if (!deviceId) {
    deviceId = `device-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem(STORAGE_KEY, deviceId);
  }
  
  return deviceId;
}
```

### API 请求

所有 API 请求自动包含设备ID：

```typescript
headers: {
  'X-Device-Id': deviceId, // 自动添加
  'Content-Type': 'application/json',
}
```

### API 调用简化

不再需要传递 `userId` 参数：

```typescript
// 之前
api.createCheckIn('default-user')
api.getCheckInStats('default-user')

// 现在
api.createCheckIn()
api.getCheckInStats()
```

## 后端实现

### 用户识别中间件

```typescript
export function identifyUser(req: Request, res: Response, next: NextFunction) {
  // 1. 从请求头获取设备ID
  let deviceId = req.headers['x-device-id'] as string;
  
  // 2. 从查询参数获取
  if (!deviceId) {
    deviceId = req.query.deviceId as string;
  }
  
  // 3. 使用IP地址（备用）
  if (!deviceId) {
    const ip = req.headers['x-forwarded-for'] || req.ip;
    deviceId = `ip-${ip.replace(/\./g, '-')}`;
  }
  
  // 获取或创建用户
  const user = userModel.getOrCreateByDeviceId(deviceId);
  req.userId = user.id;
  next();
}
```

### 路由更新

所有路由都使用中间件自动识别用户：

```typescript
router.use(identifyUser);

router.post('/', (req, res) => {
  const userId = req.userId!; // 自动获取
  // ...
});
```

## 使用场景

### 场景1：不同设备访问

- **设备A**（手机）：自动创建用户 `device-xxx`
- **设备B**（电脑）：自动创建用户 `device-yyy`
- 两个设备的数据完全独立

### 场景2：同一设备不同浏览器

- 不同浏览器有不同的 `localStorage`
- 每个浏览器会被识别为不同用户
- 如果需要共享数据，可以手动设置相同的设备ID

### 场景3：无 localStorage 环境

- 系统自动使用IP地址作为用户ID
- 同一IP的所有请求共享数据

## 定时任务

定时检查任务现在会检查**所有用户**：

```typescript
async checkAllUsers() {
  const users = userModel.getAll();
  // 并行检查所有用户
  await Promise.all(users.map(user => 
    this.checkUserStatus(user.id)
  ));
}
```

## 用户管理

### 查看所有用户

```typescript
const users = userModel.getAll();
```

### 获取用户信息

```typescript
const user = userModel.getById(userId);
```

### 更新用户信息

```typescript
userModel.update(userId, { email: 'new@example.com' });
```

## 注意事项

1. **设备ID持久化**
   - 设备ID存储在 `localStorage` 中
   - 清除浏览器数据会丢失设备ID，系统会创建新用户
   - 建议用户不要清除浏览器数据

2. **IP地址变化**
   - 如果使用IP作为用户ID，IP变化会导致创建新用户
   - 建议使用设备ID方式

3. **隐私保护**
   - 设备ID是随机生成的，不包含个人信息
   - IP地址仅用于用户识别，不会泄露

4. **数据迁移**
   - 如果需要迁移数据，可以手动设置设备ID
   - 或者导出/导入数据

## 测试

### 测试多用户

1. 打开浏览器A，访问应用
2. 打开浏览器B（或隐私模式），访问应用
3. 两个浏览器应该有独立的数据

### 测试设备ID

```javascript
// 在浏览器控制台
localStorage.getItem('restart-life-device-id')
// 返回：device-1234567890-abc123

// 清除设备ID（模拟新设备）
localStorage.removeItem('restart-life-device-id')
// 刷新页面，会生成新的设备ID
```

## 部署更新

1. **更新后端代码**
   ```bash
   cd backend
   npm run build
   pm2 restart restart-life-backend
   ```

2. **更新前端代码**
   ```bash
   npm run build
   sudo systemctl reload nginx
   ```

3. **验证**
   - 从不同设备访问
   - 检查数据是否独立
   - 查看后端日志确认用户创建

## 未来扩展

可以考虑添加：
- 用户注册/登录功能
- 设备绑定功能
- 数据同步功能
- 用户管理界面
