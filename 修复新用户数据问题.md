# 修复新用户数据问题

## 问题描述
清除浏览器缓存后，device-id变了，但进入首页还是显示已经打卡，设置中的数据还是前面默认用户的数据。

## 根本原因

1. **新用户创建时没有自动创建默认设置**
   - 当新设备访问时，后端创建了新用户
   - 但没有为新用户创建默认设置
   - 前端请求设置时返回404，可能使用了缓存的默认值

2. **前端可能使用了缓存的数据**
   - 浏览器可能缓存了API响应
   - 前端状态可能没有正确重置

3. **缺少生产环境调试日志**
   - 无法在生产环境看到用户识别过程

## 已修复的问题

### 1. 新用户自动创建默认设置 ✅
- 在 `userModel.getOrCreateByDeviceId` 中，创建新用户时自动创建默认设置
- 在 `settingsRoutes` 中，如果设置不存在，自动创建默认设置

### 2. 添加生产环境调试日志 ✅
- 用户识别中间件现在会在生产环境输出日志
- 前端API请求也会输出设备ID日志

### 3. 前端错误处理改进 ✅
- 设置页面：如果获取设置失败，使用默认值
- 首页：如果获取打卡状态失败，显示"从未打卡"

## 部署步骤

### 1. 更新后端代码
```bash
cd /var/www/restart-life/backend
npm run build
pm2 restart restart-life-backend
```

### 2. 更新前端代码
```bash
cd /var/www/restart-life
npm run build
```

### 3. 重新加载 Nginx
```bash
sudo systemctl reload nginx
```

### 4. 清除浏览器缓存
- 按 `Ctrl+Shift+Delete`（Windows）或 `Cmd+Shift+Delete`（Mac）
- 清除缓存和 Cookie
- 或者使用无痕模式测试

## 验证步骤

### 1. 检查后端日志
```bash
pm2 logs restart-life-backend --lines 50
```

应该看到：
```
🔍 用户识别中间件: { 'x-device-id': 'device-xxx', ... }
✅ 创建新用户: device-xxx
✅ 为新用户创建默认设置: device-xxx
✅ 用户识别成功: deviceId=device-xxx, userId=device-xxx
```

### 2. 检查浏览器控制台
打开 F12，查看 Console，应该看到：
```
✅ 生成新设备ID: device-xxx
📤 API请求: /checkin/today { deviceId: 'device-xxx', ... }
```

### 3. 检查数据库
```bash
sqlite3 /var/www/restart-life/backend/data/database.db

# 查看所有用户
SELECT * FROM users ORDER BY created_at DESC;

# 查看用户设置
SELECT user_id, email_notify, sms_notify FROM user_settings;

# 查看打卡记录（按用户分组）
SELECT user_id, COUNT(*) as count FROM checkins GROUP BY user_id;
```

### 4. 测试新用户
1. 清除浏览器缓存
2. 访问网站
3. 应该看到：
   - 首页：显示"从未打卡"，打卡按钮可用
   - 设置页：显示默认设置（邮件通知开启，自动报警关闭）

## 预期行为

✅ **新用户（清除缓存后）**
- 设备ID是新生成的
- 首页显示"从未打卡"
- 设置显示默认值（邮件通知开启，自动报警关闭）
- 没有联系人

✅ **已存在的用户**
- 设备ID保持不变
- 显示自己的打卡记录
- 显示自己的设置和联系人

## 如果问题仍然存在

1. **检查Nginx配置**
   确保传递了设备ID请求头：
   ```nginx
   proxy_set_header X-Device-Id $http_x_device_id;
   ```

2. **检查后端日志**
   查看用户识别是否成功：
   ```bash
   pm2 logs restart-life-backend --lines 100 | grep "用户识别"
   ```

3. **检查前端请求**
   打开浏览器开发者工具 → Network标签
   - 查看请求头是否包含 `x-device-id`
   - 查看响应数据是否正确

4. **直接测试API**
   ```bash
   # 使用curl测试（替换device-id）
   curl -H "x-device-id: device-test-123" http://localhost:3001/api/checkin/today
   ```

## 关键修复点

1. ✅ 新用户创建时自动创建默认设置
2. ✅ 获取设置时如果不存在自动创建
3. ✅ 添加生产环境调试日志
4. ✅ 改进前端错误处理
5. ✅ 确保前端使用最新的设备ID
