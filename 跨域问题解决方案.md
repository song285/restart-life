# 跨域问题解决方案

## 问题原因

前端部署后访问 `http://43.163.83.15`，但 API 请求指向 `http://43.163.83.15:3001/api`，导致跨域错误。

## 解决方案（已修复）

### ✅ 方案一：使用相对路径（推荐，已实现）

**前端配置**（`services/api.ts`）：
- 使用相对路径 `/api`，而不是绝对路径
- 请求会通过 Nginx 代理到后端，避免跨域

**优点**：
- 无需配置 CORS
- 自动适配域名/IP
- 更安全（不暴露后端端口）

**配置方式**：
前端不需要设置 `VITE_API_URL`，使用默认的相对路径即可。

### 方案二：配置后端 CORS（备选）

如果必须使用绝对路径，需要配置后端：

**后端环境变量**（`backend/.env`）：
```bash
CORS_ORIGIN=http://43.163.83.15,http://your-domain.com
```

**前端环境变量**（`.env.production`）：
```bash
VITE_API_URL=http://43.163.83.15/api
```

注意：使用 `/api` 而不是 `:3001/api`，因为通过 Nginx 代理。

## 当前配置说明

### 前端配置
- ✅ 已修改为使用相对路径 `/api`
- ✅ 如果设置了 `VITE_API_URL` 环境变量，会使用环境变量
- ✅ 默认使用 `/api`（通过 Nginx 代理）

### 后端配置
- ✅ 允许没有 origin 的请求（通过 Nginx 代理的请求）
- ✅ 生产环境更宽松的 CORS 策略
- ✅ 可以通过环境变量 `CORS_ORIGIN` 配置允许的来源

### Nginx 配置
- ✅ 已配置 `/api` 代理到 `http://localhost:3001`
- ✅ 正确传递请求头

## 部署步骤

1. **重新构建前端**
   ```bash
   cd /var/www/restart-life
   npm run build
   ```

2. **重启后端**（如果需要更新 CORS 配置）
   ```bash
   cd backend
   pm2 restart restart-life-backend
   ```

3. **重新加载 Nginx**
   ```bash
   sudo systemctl reload nginx
   ```

## 验证

1. 打开浏览器开发者工具（F12）
2. 访问 `http://43.163.83.15`
3. 查看 Network 标签，API 请求应该是：
   - URL: `http://43.163.83.15/api/...`
   - Status: 200 OK
   - 没有 CORS 错误

## 如果仍有问题

1. **检查 Nginx 配置**
   ```bash
   sudo nginx -t
   sudo tail -f /var/log/nginx/error.log
   ```

2. **检查后端日志**
   ```bash
   pm2 logs restart-life-backend
   ```

3. **检查后端是否运行**
   ```bash
   curl http://localhost:3001/health
   ```

4. **检查 Nginx 代理**
   ```bash
   curl http://localhost/api/health
   ```

## 常见错误

### 错误：Access to fetch at 'http://43.163.83.15:3001/api/...' from origin 'http://43.163.83.15' has been blocked by CORS policy

**原因**：前端仍在使用带端口的绝对路径

**解决**：
1. 确保前端使用相对路径 `/api`
2. 重新构建前端：`npm run build`
3. 清除浏览器缓存

### 错误：404 Not Found

**原因**：Nginx 代理配置不正确

**解决**：
1. 检查 Nginx 配置中的 `proxy_pass` 是否正确
2. 确保后端服务运行在 3001 端口
3. 重启 Nginx：`sudo systemctl restart nginx`
